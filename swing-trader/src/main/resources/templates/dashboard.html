<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Swing Trader Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 font-sans">

<div class="container mx-auto p-4 sm:p-8">
    <div class="flex items-center mb-8">
        <svg class="w-12 h-12 text-blue-500 mr-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
        </svg>
        <h1 class="text-4xl font-bold text-slate-100 tracking-tight">Swing Trading Bot Dashboard</h1>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 bg-slate-800 rounded-xl shadow-lg overflow-hidden">
            <div class="p-6 border-b border-slate-700">
                <h2 class="text-2xl font-semibold text-slate-200">Open Positions</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-slate-700/50 text-slate-400 uppercase text-sm font-semibold">
                    <tr>
                        <th class="py-3 px-6 text-left">Symbol</th>
                        <th class="py-3 px-6 text-left">Entry Date</th>
                        <th class="py-3 px-6 text-right">Quantity</th>
                        <th class="py-3 px-6 text-right">Entry Price</th>
                        <th class="py-3 px-6 text-right">Current Price</th>
                        <th class="py-3 px-6 text-right">Unrealized P/L</th>
                    </tr>
                    </thead>
                    <tbody id="positions-table-body" class="text-slate-300">
                    <tr th:each="position : ${positions}" class="border-b border-slate-700">
                        <td class="py-4 px-6 font-medium text-slate-100" th:text="${position.symbol}">AAPL</td>
                        <td class="py-4 px-6" th:text="${position.entryDate}">2025-08-28</td>
                        <td class="py-4 px-6 text-right font-mono" th:text="${#numbers.formatDecimal(position.quantity, 1, 4)}">15.1234</td>
                        <td class="py-4 px-6 text-right font-mono" th:text="${#numbers.formatCurrency(position.entryPrice)}">$175.50</td>
                        <td class="py-4 px-6 text-right font-mono">Loading...</td>
                        <td class="py-4 px-6 text-right font-mono font-bold">Loading...</td>
                    </tr>
                    <tr th:if="${positions.isEmpty()}">
                        <td colspan="6" class="py-6 px-4 text-center text-slate-500 italic">No open positions.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-slate-800 rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-semibold text-slate-200 mb-4 border-b border-slate-700 pb-4">Activity Log</h2>
            <div id="activity-log" class="space-y-3 text-sm text-slate-400 h-96 overflow-y-auto">
            </div>
        </div>
    </div>
</div>

<script>
    const positionsTableBody = document.getElementById('positions-table-body');
    const activityLog = document.getElementById('activity-log');

    // Function to update the portfolio table
    async function updatePortfolio() {
        try {
            const response = await fetch('/api/positions');
            const positions = await response.json();

            positionsTableBody.innerHTML = ''; // Clear the table

            if (positions.length === 0) {
                positionsTableBody.innerHTML = '<tr><td colspan="6" class="py-6 px-4 text-center text-slate-500 italic">No open positions.</td></tr>';
                return;
            }

            positions.forEach(pos => {
                const plColor = pos.unrealizedPl >= 0 ? 'text-green-400' : 'text-red-400';
                const plSign = pos.unrealizedPl >= 0 ? '+' : '';

                const row = `
                    <tr class="border-b border-slate-700">
                        <td class="py-4 px-6 font-medium text-slate-100">${pos.symbol}</td>
                        <td class="py-4 px-6">${pos.entryDate}</td>
                        <td class="py-4 px-6 text-right font-mono">${parseFloat(pos.quantity).toFixed(4)}</td>
                        <td class="py-4 px-6 text-right font-mono">$${parseFloat(pos.entryPrice).toFixed(2)}</td>
                        <td class="py-4 px-6 text-right font-mono">$${parseFloat(pos.currentPrice).toFixed(2)}</td>
                        <td class="py-4 px-6 text-right font-mono font-bold ${plColor}">
                            ${plSign}$${parseFloat(pos.unrealizedPl).toFixed(2)}
                        </td>
                    </tr>`;
                positionsTableBody.innerHTML += row;
            });
        } catch (error) {
            console.error("Error fetching portfolio:", error);
            positionsTableBody.innerHTML = '<tr><td colspan="6" class="py-6 px-4 text-center text-red-400">Error loading portfolio data.</td></tr>';
        }
    }

    // Function to update the activity log
    async function updateActivityLog() {
        try {
            const response = await fetch('/api/activity');
            const logEntries = await response.json();

            activityLog.innerHTML = ''; // Clear the log

            if (logEntries.length === 0) {
                activityLog.innerHTML = '<p class="italic text-slate-500">No activity yet...</p>';
                return;
            }

            logEntries.forEach(entry => {
                const p = document.createElement('p');
                p.textContent = entry;
                activityLog.appendChild(p);
p            });
        } catch (error) {
            console.error("Error fetching activity log:", error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Run once on page load
        updatePortfolio();
            updateActivityLog();

        // Then run every 10 seconds to get fresh data
        setInterval(() => {
            updatePortfolio();
            updateActivityLog();
        }, 10000); // 10 seconds
    });
</script>

</body>
</html>